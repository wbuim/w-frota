<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin - W-Frota</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* CABE√áALHO MODERNO */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; color: #2c3e50; font-size: 22px; display: flex; align-items: center; gap: 10px; }
        
        /* Badges de N√≠vel */
        .badge-nivel { background: #007bff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; text-transform: uppercase; }
        .badge-sec { background: #6f42c1; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }

        .btn-top { text-decoration: none; font-weight: 600; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; transition: 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-users { background: #6f42c11a; color: #6f42c1; }
        .btn-users:hover { background: #6f42c1; color: white; }
        .btn-relatorio { background: #007bff1a; color: #007bff; }
        .btn-relatorio:hover { background: #007bff; color: white; }
        
        .btn-sair { background: #dc35451a; color: #dc3545; }
        .btn-sair:hover { background: #dc3545; color: white; }
        .user-area { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        /* GR√ÅFICOS */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; height: 250px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: center; }

        /* CARDS PRINCIPAIS */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: transform 0.2s; border-top: 5px solid #ccc; }
        .card:hover { transform: translateY(-3px); }
        
        .card-saida { border-color: #007bff; }
        .card-transito { border-color: #28a745; }
        .card-abastecimento { border-color: #ffc107; }
        .card-manutencao { border-color: #dc3545; }

        h2 { margin-top: 0; color: #444; margin-bottom: 15px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        /* FORMUL√ÅRIOS */
        label { display: block; margin: 12px 0 4px; font-weight: 600; font-size: 12px; color: #666; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-size: 14px; background: #fafafa; transition: 0.2s; }
        input:focus, select:focus { border-color: #007bff; outline: none; background: white; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        
        /* Input de Busca */
        .input-busca { margin-bottom: 15px; padding: 12px; border: 2px solid #ddd; background: #fff; font-size: 16px; width: 100%; border-radius: 8px; }
        .input-busca:focus { border-color: #007bff; }

        button { width: 100%; margin-top: 20px; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; color: white; font-size: 14px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .btn-saida { background: linear-gradient(45deg, #007bff, #0056b3); }
        .btn-chegada { background: linear-gradient(45deg, #28a745, #1e7e34); margin-top: 5px; }
        .btn-abastecimento { background: linear-gradient(45deg, #ffc107, #d39e00); color: #333; }
        .btn-manutencao { background: linear-gradient(45deg, #dc3545, #a71d2a); }
        .btn-cadastro { background: #6c757d; width: auto; margin-top: 0; padding: 8px 20px; }

        /* Card Retorno */
        .card-chegada { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        
        /* Bot√µes R√°pidos KM */
        .btn-km-rapido { background: #e9ecef; color: #333; border: 1px solid #ced4da; padding: 6px 10px; font-size: 11px; margin-top: 5px; width: auto; display: inline-block; box-shadow: none; }
        .btn-km-rapido:hover { background: #dee2e6; transform: none; }

        /* Tabela Frota */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; }
        th { background: #f8f9fa; text-align: left; padding: 15px; color: #555; font-size: 12px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; background: white; }
        tr:last-child td { border-bottom: none; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-block; }
        .status-disp { background: #d4edda; color: #155724; }
        .status-uso { background: #f8d7da; color: #721c24; }
        .status-manu { background: #fff3cd; color: #856404; }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .user-area { flex-wrap: wrap; justify-content: center; }
            .stats-row { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
    
    <script>
        // Fun√ß√£o para confirmar Logout com SweetAlert2
        function confirmarSair(event) {
            event.preventDefault(); 
            Swal.fire({
                title: 'Sair do Sistema?',
                text: "Voc√™ precisar√° fazer login novamente.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, sair!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/logout';
                }
            })
        }

        // Fun√ß√£o de Filtro de Tabela (Busca Instant√¢nea)
        function filtrarTabela(inputId, tabelaId) {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById(inputId);
            filter = input.value.toUpperCase();
            table = document.getElementById(tabelaId);
            tr = table.getElementsByTagName("tr");

            for (i = 1; i < tr.length; i++) { // Come√ßa do 1 para pular o cabe√ßalho
                // Busca nas duas primeiras colunas (Modelo e Placa)
                let encontrou = false;
                td0 = tr[i].getElementsByTagName("td")[0]; // Coluna Modelo
                td1 = tr[i].getElementsByTagName("td")[1]; // Coluna Placa
                
                if (td0 || td1) {
                    if (td0.textContent.toUpperCase().indexOf(filter) > -1 || td1.textContent.toUpperCase().indexOf(filter) > -1) {
                        encontrou = true;
                    }
                }
                tr[i].style.display = encontrou ? "" : "none";
            }
        }

        // M√°scara para Placa (For√ßa Mai√∫scula e Formato)
        function formatarPlaca(input) {
            let valor = input.value.toUpperCase();
            valor = valor.replace(/[^A-Z0-9-]/g, ''); // Remove caracteres especiais estranhos
            input.value = valor;
        }
    </script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>
            üöõ W-Frota
            <% if(user.nivel === 99) { %> <span class="badge-nivel">Corporativo</span> <% } %>
            <span class="badge-sec"><%= user.nomeDepartamento %></span>
        </h1>
        
        <div class="user-area">
            <a href="/usuarios" class="btn-top btn-users">üè¢ Departamentos & Equipe</a>
            <a href="/relatorio_motorista" class="btn-top btn-users" style="color:#28a745; background:#28a7451a;">üëÆ Condutores</a>
            <a href="/relatorio_geral" target="_blank" class="btn-top btn-relatorio">üìÑ Relat√≥rios</a>
            <span style="color: #ccc;">|</span>
            <span style="font-weight:bold; font-size: 14px;"><%= user.nome %></span>
            <a href="/logout" onclick="confirmarSair(event)" class="btn-top btn-sair">Sair</a>
        </div>
    </div>

    <% if (typeof alertas_oleo !== 'undefined' && alertas_oleo && alertas_oleo.length > 0) { %>
        <div style="background: #fff3cd; border-left: 5px solid #ffc107; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <h3 style="margin: 0 0 10px 0; color: #856404; font-size: 16px;">‚ö†Ô∏è MANUTEN√á√ÉO NECESS√ÅRIA</h3>
            <ul style="margin: 0; padding-left: 20px; color: #856404; font-size: 14px;">
                <% alertas_oleo.forEach(v => { %>
                    <li style="margin-bottom: 5px;"><strong><%= v.modelo %> (<%= v.placa %>)</strong>: Trocar √≥leo urgente!</li>
                <% }) %>
            </ul>
        </div>
    <% } %>

    <div class="stats-row">
        <div class="chart-box"><canvas id="graficoStatus"></canvas></div>
        <div class="chart-box"><canvas id="graficoFinanceiro"></canvas></div>
    </div>

    <div class="grid">
        <div class="card card-saida">
            <h2>üì§ Nova Sa√≠da</h2>
            <form action="/registrar_saida" method="POST">
                <label>Ve√≠culo Dispon√≠vel</label>
                <select name="veiculo_id" required>
                    <option value="">-- Selecione --</option>
                    <% veiculos.forEach(v => { %>
                        <% if (v.status === 'Dispon√≠vel') { %>
                            <option value="<%= v.id %>"><%= v.modelo %> (<%= v.placa %>)</option>
                        <% } %>
                    <% }) %>
                </select>
                <label>Condutor</label>
                <select name="motorista" required>
                    <option value="">-- Quem dirige? --</option>
                    <% usuarios.forEach(u => { %>
                        <option value="<%= u.nome %>"><%= u.nome %></option>
                    <% }) %>
                </select>
                <label>Destino</label>
                <input type="text" name="destino" placeholder="Ex: Cliente X / Rota" required>
                <button type="submit" class="btn-saida">Registrar Sa√≠da</button>
            </form>
        </div>

        <div class="card card-transito">
            <h2>üì• Retorno</h2>
            <div id="lista-transito">
                <% if(em_transito.length === 0) { %>
                    <p style="color:#999; text-align:center; padding: 40px;">P√°tio Cheio (Nenhum ve√≠culo na rua).</p>
                <% } %>
                <% em_transito.forEach(mov => { %>
                    <div class="card-chegada">
                        <strong>üöó <%= mov.veiculo.modelo %></strong><br>
                        <small style="color: #666;"><%= mov.motorista %></small>
                        
                        <form action="/registrar_chegada" method="POST" style="margin-top: 10px;">
                            <input type="hidden" name="mov_id" value="<%= mov.id %>">
                            <label>KM Chegada</label>
                            <div style="display:flex; gap:5px;">
                                <input type="number" id="km_input_<%= mov.id %>" name="km_chegada" value="<%= mov.km_saida %>" required min="<%= mov.km_saida %>">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <button type="button" class="btn-km-rapido" onclick="somarKm('<%= mov.id %>', 5)">+5</button>
                                <button type="button" class="btn-km-rapido" onclick="somarKm('<%= mov.id %>', 10)">+10</button>
                                <button type="button" class="btn-km-rapido" onclick="somarKm('<%= mov.id %>', 50)">+50</button>
                            </div>
                            <input type="text" name="observacao" placeholder="Obs (Opcional)">
                            <button type="submit" class="btn-chegada">Dar Baixa</button>
                        </form>
                    </div>
                <% }) %>
            </div>
        </div>

        <div class="card card-abastecimento">
            <h2>‚õΩ Abastecimento</h2>
            <form action="/registrar_abastecimento" method="POST" enctype="multipart/form-data">
                <label>Ve√≠culo</label>
                <select name="veiculo_id" required>
                    <% veiculos.forEach(v => { %>
                        <option value="<%= v.id %>"><%= v.modelo %> (<%= v.placa %>)</option>
                    <% }) %>
                </select>
                <label>Condutor</label>
                <select name="motorista" required>
                    <option value="">-- Selecione --</option>
                    <% usuarios.forEach(u => { %>
                        <option value="<%= u.nome %>"><%= u.nome %></option>
                    <% }) %>
                </select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Total (R$)</label><input type="number" step="0.01" name="valor_total" placeholder="0.00" required></div>
                    <div><label>Litros</label><input type="number" step="0.01" name="litros" placeholder="0.00" required></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Comb.</label><select name="tipo_combustivel"><option>Gasolina</option><option>Etanol</option><option>Diesel</option></select></div>
                    <div><label>KM</label><input type="number" name="km_momento" required></div>
                </div>
                <label>Posto</label><input type="text" name="posto" placeholder="Nome do Posto">
                
                <div style="margin-top: 15px; background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px dashed #d39e00;">
                    <label style="margin:0;">üì∏ Foto do Comprovante (Opcional)</label>
                    <input type="file" name="foto" accept="image/*" style="border:none; background:transparent; padding:5px 0;">
                </div>

                <button type="submit" class="btn-abastecimento">Salvar</button>
            </form>
        </div>

        <div class="card card-manutencao">
            <h2>üõ†Ô∏è Manuten√ß√£o</h2>
            <form action="/registrar_manutencao" method="POST" enctype="multipart/form-data">
                <label>Ve√≠culo</label>
                <select name="veiculo_id" required>
                    <% veiculos.forEach(v => { %>
                        <option value="<%= v.id %>"><%= v.modelo %> (<%= v.placa %>)</option>
                    <% }) %>
                </select>
                <label>Oficina</label><input type="text" name="oficina" required>
                <label>Servi√ßo</label><textarea name="descricao" rows="2" required></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Valor (R$)</label><input type="number" step="0.01" name="valor" required></div>
                    <div><label>KM</label><input type="number" name="km_momento" required></div>
                </div>
                <input type="date" name="data" value="<%= new Date().toISOString().split('T')[0] %>">
                
                <div style="margin-top: 15px; background: #f8d7da; padding: 10px; border-radius: 5px; border: 1px dashed #dc3545;">
                    <label style="margin:0; color:#721c24;">üì∏ Foto da Nota (Opcional)</label>
                    <input type="file" name="foto" accept="image/*" style="border:none; background:transparent; padding:5px 0;">
                </div>

                <button type="submit" class="btn-manutencao">Lan√ßar Manuten√ß√£o</button>
            </form>
        </div>
    </div>

    <div class="card" style="margin-top: 30px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;">üöó Frota / Departamentos</h2>
            <details>
                <summary style="color:#007bff; font-weight:bold; cursor:pointer;">+ Novo Ve√≠culo</summary>
                <form action="/novo_veiculo" method="POST" style="margin-top:10px; padding:15px; background:#f8f9fa; border-radius:8px;">
                    
                    <% if (user.nivel === 99 && typeof departamentos !== 'undefined' && departamentos.length > 0) { %>
                        <label style="color: #6f42c1;">Pertence ao Departamento:</label>
                        <select name="departamento_destino" required style="border: 2px solid #6f42c1;">
                            <% departamentos.forEach(dep => { %>
                                <option value="<%= dep.id %>"><%= dep.nome %></option>
                            <% }) %>
                        </select>
                    <% } %>

                    <input type="text" name="modelo" placeholder="Modelo" required>
                    <input type="text" name="marca" placeholder="Marca" required style="margin: 5px 0;">
                    <input type="text" name="placa" placeholder="Placa (ABC-1234)" onkeyup="formatarPlaca(this)" required>
                    
                    <div style="display: flex; gap: 10px; margin: 5px 0;">
                        <input type="number" name="km_atual" placeholder="KM Atual (Hod√¥metro)" required style="margin:0;">
                        <input type="number" name="km_ultima_troca_oleo" placeholder="KM √öltima Troca √ìleo" style="margin:0;">
                    </div>
                    <small style="color: #666; font-size: 11px; display: block; margin-bottom: 5px;">* Se deixar a troca de √≥leo vazia, ser√° considerado 0.</small>

                    <button type="submit" class="btn-cadastro">Cadastrar</button>
                </form>
            </details>
        </div>
        
        <input type="text" id="buscaFrota" onkeyup="filtrarTabela('buscaFrota', 'tabelaFrota')" placeholder="üîç Buscar ve√≠culo ou placa..." class="input-busca">
        
        <table id="tabelaFrota">
            <thead><tr><th>Ve√≠culo</th><th>Placa</th><th>KM</th><th>Status</th></tr></thead>
            <tbody>
                <% veiculos.forEach(v => { %>
                    <tr>
                        <td><a href="/veiculo/<%= v.id %>" style="color:#007bff; text-decoration:none; font-weight:bold;"><%= v.modelo %></a></td>
                        <td><%= v.placa %></td>
                        <td><%= v.km_atual %> km</td>
                        <td>
                            <% if(v.status === 'Dispon√≠vel') { %> <span class="status-badge status-disp">Livre</span>
                            <% } else if(v.status === 'Manuten√ß√£o') { %> <span class="status-badge status-manu">Oficina</span>
                            <% } else { %> <span class="status-badge status-uso"><%= v.status %></span> <% } %>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
</div>

<script>
    function somarKm(id, valor) {
        const input = document.getElementById('km_input_' + id);
        input.value = (parseInt(input.value) || 0) + valor;
    }

    // --- DETECTOR DE CONEX√ÉO (ESCUDO ANTI-ERRO) ---
    const botoes = document.querySelectorAll('button[type="submit"]');
    
    function atualizarStatusConexao() {
        const online = navigator.onLine;
        
        if (!online) {
            botoes.forEach(btn => {
                btn.disabled = true;
                btn.dataset.textoOriginal = btn.innerText;
                btn.innerText = "üì° Sem Internet (Aguardando Sinal...)";
                btn.style.opacity = "0.6";
                btn.style.cursor = "not-allowed";
            });
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: null });
            Toast.fire({ icon: 'error', title: 'Voc√™ est√° Offline. N√£o feche a p√°gina.' });
        } else {
            botoes.forEach(btn => {
                btn.disabled = false;
                if(btn.dataset.textoOriginal) btn.innerText = btn.dataset.textoOriginal;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            });
            if (document.body.dataset.jaCaiu === "sim") {
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'success', title: 'Conex√£o restabelecida! Pode salvar.' });
            }
        }
    }

    window.addEventListener('online', () => { document.body.dataset.jaCaiu = "sim"; atualizarStatusConexao(); });
    window.addEventListener('offline', () => { document.body.dataset.jaCaiu = "sim"; atualizarStatusConexao(); });
    atualizarStatusConexao();

    // Gr√°ficos
    const chartStatus = new Chart(document.getElementById('graficoStatus'), {
        type: 'doughnut',
        data: { labels: ['Livres', 'Em Uso', 'Oficina'], datasets: [{ data: [<%= stats.ativos %>, <%= stats.ocupados %>, <%= stats.oficina %>], backgroundColor: ['#28a745', '#dc3545', '#ffc107'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: true, text: 'Status da Frota' } } }
    });
    const chartFinanceiro = new Chart(document.getElementById('graficoFinanceiro'), {
        type: 'bar',
        data: { labels: ['Combust√≠vel', 'Manuten√ß√£o'], datasets: [{ label: 'R$', data: [<%= stats.totalAbastecimentos %>, <%= stats.totalManutencao %>], backgroundColor: ['#ffc107', '#dc3545'], borderRadius: 5 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Custos Totais' } } }
    });
</script>
</body>
</html>